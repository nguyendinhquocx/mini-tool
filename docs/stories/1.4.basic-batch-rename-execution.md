# Story 1.4: Basic Batch Rename Execution

## Status

Draft

## Story

**As a** user,
**I want** to execute batch rename operations on selected folder,
**so that** I can apply Vietnamese normalization to multiple files simultaneously.

## Acceptance Criteria

1. "Rename Files" button triggers batch operation on all files in selected folder
2. Each file renamed according to Vietnamese normalization rules
3. File extensions preserved during rename process
4. Operation handles files that would result in duplicate names
5. Basic success/failure messaging displayed to user
6. Application remains responsive during rename operation
7. File system errors handled với appropriate user feedback
8. Operation completes successfully for typical use cases (50-100 files)

## Tasks / Subtasks

- [ ] Create batch rename execution engine (AC: 1, 2, 3, 8)
  - [ ] Implement execute_batch_rename() method trong FileOperationsEngine
  - [ ] Add file system operation với proper error handling
  - [ ] Integrate với VietnameseNormalizer cho text processing
  - [ ] Implement progress tracking cho large file operations
  - [ ] Add validation cho rename operations before execution

- [ ] Handle duplicate name conflicts (AC: 4)
  - [ ] Implement conflict detection algorithm cho duplicate processed names
  - [ ] Add automatic numbering system cho conflicts (file.txt, file_1.txt, file_2.txt)
  - [ ] Create conflict resolution strategy với user-configurable options
  - [ ] Add conflict preview trong RenamePreview display
  - [ ] Implement safe rename approach tránh overwriting files

- [ ] Implement operation progress feedback system (AC: 5, 6)
  - [ ] Create ProgressDialog component cho long-running operations
  - [ ] Add progress callback system với percentage và current file tracking
  - [ ] Implement background threading cho non-blocking UI
  - [ ] Add cancel operation functionality với proper cleanup
  - [ ] Update StateManager để track operation progress

- [ ] Create comprehensive error handling (AC: 7)
  - [ ] Implement file system error categorization (permission, disk space, file in use)
  - [ ] Add recovery options cho common error scenarios
  - [ ] Create partial operation handling (some files succeed, some fail)
  - [ ] Implement retry mechanism cho recoverable errors
  - [ ] Add error logging với operation context

- [ ] Add operation history và undo support (AC: 5, 7)
  - [ ] Create operation tracking trong SQLite database
  - [ ] Implement undo functionality cho batch operations
  - [ ] Add operation history persistence với detailed file mappings
  - [ ] Create OperationHistory service cho audit trail
  - [ ] Add "Undo Last Operation" button trong UI

- [ ] Integrate với UI components (AC: 1, 5, 6)
  - [ ] Add "Rename Files" button trong main window
  - [ ] Connect button to batch execution workflow
  - [ ] Update FilePreviewComponent để show operation results
  - [ ] Add success/failure summary dialog
  - [ ] Implement UI state management cho operation lifecycle

- [ ] Create comprehensive result reporting (AC: 5, 8)
  - [ ] Implement OperationResult dataclass với detailed metrics
  - [ ] Add success/failure counts và file lists
  - [ ] Create result display dialog với operation summary
  - [ ] Add detailed error reporting cho failed files
  - [ ] Implement result persistence cho operation history

## Dev Notes

### Previous Story Context

From Story 1.3 completion notes:
- Vietnamese Text Normalization Engine implemented với VietnameseNormalizer class
- FileOperationsEngine created với normalization integration
- RenamePreview và FileInfo models ready for batch operations
- Comprehensive error handling patterns established

From Story 1.2 completion notes:
- UI framework với StateManager và component architecture ready
- Folder selection và file preview components working
- Application controller pattern implemented
- Thread-safe UI update patterns established

### Batch Operation Architecture

From Epic 1 requirements [Source: docs/prd/epic-1-core-application-foundation-basic-rename.md]:

**Operation Requirements**:
- Batch rename on all files trong selected folder
- Vietnamese normalization rules applied
- File extensions preserved
- Duplicate name handling
- Success/failure messaging
- Responsive UI during operations
- Error handling với user feedback
- Handle 50-100 files efficiently

### Core Workflow Integration

From core workflows [Source: architecture/core-workflows.md]:

**Primary Rename Workflow Completion**:
1. User selects folder (completed in Story 1.2)
2. File Engine scans directory (completed in Story 1.2)  
3. Vietnamese Normalizer generates preview (completed in Story 1.3)
4. UI displays before/after preview (integration ready)
5. **User confirms và executes rename operation** (this story)

**Error Recovery Workflow**:
- Partial failure handling với recovery options
- Retry failed operations functionality  
- Undo successful changes option
- Detailed error logging và user feedback

### Database Schema Integration

From database schema [Source: architecture/database-schema.md]:

**Operation History Tracking**:
```sql
CREATE TABLE operation_history (
    operation_id TEXT PRIMARY KEY,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    folder_path TEXT NOT NULL,
    operation_type TEXT NOT NULL, -- 'batch_rename', 'undo'
    total_files INTEGER NOT NULL,
    successful_files INTEGER NOT NULL,
    failed_files INTEGER NOT NULL,
    status TEXT NOT NULL, -- 'success', 'partial', 'failed'
    error_summary TEXT
);

CREATE TABLE file_operations (
    operation_id TEXT NOT NULL,
    original_name TEXT NOT NULL,
    new_name TEXT NOT NULL,
    file_path TEXT NOT NULL,
    status TEXT NOT NULL, -- 'success', 'failed', 'skipped'
    error_message TEXT,
    FOREIGN KEY (operation_id) REFERENCES operation_history(operation_id)
);
```

### Error Handling Strategy Integration

From error handling strategy [Source: architecture/error-handling-strategy.md]:

**Error Response Format**:
```python
@dataclass
class ApplicationError:
    code: ErrorCode
    message: str
    details: Dict[str, Any]
    operation_id: Optional[str]
    file_path: Optional[str]
    recovery_suggestions: List[str]
```

**Error Categories for Batch Operations**:
- `PERMISSION_DENIED` - Files require administrator access
- `FILE_IN_USE` - Files open trong other applications
- `DISK_FULL` - Insufficient disk space
- `FILE_NOT_FOUND` - Files moved during operation
- `INVALID_PATH` - Invalid file paths or names

**Recovery Options**:
- Retry as administrator
- Retry after closing files
- Skip locked files và continue
- Undo successful changes
- Partial operation completion

### API Interface Requirements

From API specification [Source: architecture/api-specification.md]:

**FileOperationsEngine Interface Extension**:
```python
class FileOperationsEngine:
    def execute_rename(self, operations: List[RenameOperation]) -> OperationResult
    def undo_operation(self, operation_id: str) -> UndoResult
    def handle_duplicate_conflicts(self, operations: List[RenameOperation]) -> List[RenameOperation]
```

**Progress Tracking Interface**:
```python
from typing import Callable

ProgressCallback = Callable[[float, str], None]  # (percentage, current_file)

def execute_batch_rename(
    self, 
    operations: List[RenameOperation],
    progress_callback: ProgressCallback = None
) -> OperationResult
```

### Data Model Extensions

From data models [Source: architecture/data-models.md]:

**Operation Result Model**:
```python
@dataclass
class OperationResult:
    operation_id: str
    total_files: int
    successful_files: int
    failed_files: int
    status: str  # 'success', 'partial', 'failed'
    file_results: List[FileOperationResult]
    error_summary: Optional[str]
    execution_time: float
```

**File Operation Result Model**:
```python
@dataclass  
class FileOperationResult:
    original_name: str
    new_name: str
    file_path: str
    status: str  # 'success', 'failed', 'skipped'
    error_code: Optional[ErrorCode]
    error_message: Optional[str]
```

### UI Components Integration

From frontend architecture [Source: architecture/frontend-architecture.md]:

**Progress Dialog Component**:
```python
class ProgressDialog(BaseComponent):
    def show_progress(self, percentage: float, current_file: str)
    def allow_cancellation(self, cancel_callback: Callable)
    def show_completion_summary(self, result: OperationResult)
```

**State Management Updates**:
```python
@dataclass
class ApplicationState:
    current_operation_id: Optional[str]
    operation_in_progress: bool
    progress_percentage: float
    current_file_being_processed: Optional[str]
    last_operation_result: Optional[OperationResult]
```

### Technology Stack Requirements

From tech stack [Source: architecture/tech-stack.md]:

| Component | Technology | Version | Purpose |
|-----------|------------|---------|---------|
| Database | SQLite | Built-in | Operation history và settings |
| Threading | Python threading | Built-in | Non-blocking batch operations |
| Progress UI | tkinter.ttk | Built-in | Progress bars và dialogs |
| File Operations | Python pathlib | Built-in | Safe file system operations |
| Business Logic Language | Python | 3.11+ | Batch processing logic |

### Source Tree Structure Extensions

From unified project structure [Source: architecture/unified-project-structure.md]:

```
src/
├── core/
│   ├── services/
│   │   ├── file_operations_engine.py     # Extended với batch execution
│   │   ├── operation_history_service.py  # New: Operation tracking
│   │   └── database_service.py           # New: SQLite operations
│   ├── repositories/
│   │   ├── operation_repository.py       # New: Operation persistence
│   │   └── config_repository.py          # Configuration storage
├── ui/
│   ├── components/
│   │   ├── progress_dialog.py            # New: Operation progress
│   │   └── result_dialog.py              # New: Operation results
│   └── dialogs/
│       └── confirm_dialog.py             # Operation confirmation
```

### Threading và UI Responsiveness

From coding standards [Source: architecture/coding-standards.md]:

**Threading Discipline**:
- Long-running operations execute on background threads
- UI updates must go through StateManager on main thread
- Proper progress callbacks với thread-safe operations
- Cancel operation handling với proper cleanup
- Exception propagation từ worker threads to UI

**Resource Management**:
- Always use context managers cho file operations
- Proper cleanup trong cancel scenarios
- Database transactions cho operation atomicity
- Memory efficient processing cho large file sets

### Testing

#### Testing Standards

From testing strategy [Source: architecture/testing-strategy.md]:

- **Integration Tests**: End-to-end batch rename workflow testing
- **Error Scenario Tests**: File permission, disk space, file locks
- **Performance Tests**: Large file set operations (50-100 files)
- **UI Tests**: Progress dialog, result display, error handling

#### Specific Testing Requirements for This Story:

- Test successful batch rename operations với various file counts
- Test duplicate name conflict resolution
- Test partial operation failure scenarios
- Test progress tracking và UI responsiveness
- Test operation cancellation với proper cleanup
- Test undo functionality với complex operations
- Test error recovery workflows
- Test database operation history persistence
- Test UI state management throughout operation lifecycle

#### Test Scenarios

**Batch Operation Test Cases**:
- 10 files với normal Vietnamese names
- 50 files với mixed content (Vietnamese, English, numbers)
- 100 files để test performance limits
- Files với duplicate processed names
- Files với permission issues
- Files locked by other applications
- Operations on various file types (.txt, .docx, .pdf, .jpg)

#### Code Quality Standards

From coding standards [Source: architecture/coding-standards.md]:

- **Error Handling Consistency**: Use centralized ErrorHandler với recovery options
- **Threading Discipline**: Background operations với proper UI thread communication
- **Resource Management**: Context managers, proper cleanup, database transactions
- **Logging Standards**: Structured logging với operation IDs for debugging

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-30 | v1.0 | Initial story creation from Epic 1 requirements | Anh Minh (SM) |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

*(This section will be populated by QA Agent after story completion)*