# Story 3.2: User Preferences & Settings

## Status

Approved

## Story

**As a** user,
**I want** to customize normalization rules và application behavior,
**so that** I can tailor the tool to my specific workflow needs.

## Acceptance Criteria

1. Settings dialog accessible through main menu hoặc button
2. User can enable/disable specific normalization rules (diacritics, case, special chars)
3. Custom replacement rules for specific characters hoặc patterns
4. Application remembers window size và position between sessions
5. Recent folders list for quick access to commonly used directories
6. Settings persist to configuration file in user profile directory
7. "Reset to Defaults" functionality available for all preferences
8. Settings changes apply immediately without requiring application restart

## Tasks / Subtasks

- [ ] Implement configuration data models và persistence layer (AC: 6, 8)
  - [ ] Create AppConfiguration data model với normalization rules
  - [ ] Implement ConfigRepository with SQLite backend
  - [ ] Create ConfigService với load/save operations
  - [ ] Add user profile directory configuration management
- [ ] Build settings dialog UI component (AC: 1, 7)
  - [ ] Create SettingsDialog với tabbed interface
  - [ ] Implement settings panel với organized categories
  - [ ] Add "Reset to Defaults" functionality with confirmation
  - [ ] Integrate settings access từ main menu và toolbar
- [ ] Implement normalization rules customization (AC: 2, 3)
  - [ ] Create checkboxes cho enable/disable rules (diacritics, case, special chars)
  - [ ] Build custom replacement rules editor với add/remove/edit functionality
  - [ ] Add rule validation và preview functionality
  - [ ] Implement rule priority và ordering system
- [ ] Add UI preferences persistence (AC: 4, 5)
  - [ ] Implement window size và position saving/restoration
  - [ ] Create recent folders management với maximum limit
  - [ ] Add recent folders quick access menu
  - [ ] Implement UI preference auto-save on changes
- [ ] Integrate với existing application systems (AC: 8)
  - [ ] Connect configuration service with normalization engine
  - [ ] Update application state management cho settings changes
  - [ ] Implement real-time settings application without restart
  - [ ] Add settings validation và error handling
- [ ] Implement comprehensive testing (All ACs)
  - [ ] Unit tests cho configuration models và services
  - [ ] Integration tests cho settings persistence workflow
  - [ ] UI tests cho settings dialog functionality
  - [ ] End-to-end tests cho settings application và persistence

## Dev Notes

### Previous Story Context

From Story 3.1 completion notes:

- UI component integration patterns established cho dialog management
- State management extensions available cho configuration state
- Error handling integration established cho validation và persistence errors
- Cross-platform compatibility considerations implemented

From Story 2.4 completion notes:

- Comprehensive error handling system available cho configuration validation
- Advanced error dialogs available cho settings error recovery
- Validation service patterns established cho input validation
- Logging system available cho settings change tracking

### Configuration Management Architecture

From data models [Source: architecture/data-models.md]:

**AppConfiguration Data Model**:

```python
@dataclass
class AppConfiguration:
    normalization_rules: Dict[str, bool]
    ui_preferences: Dict[str, Any]
    operation_settings: Dict[str, Any]
    recent_folders: List[str]
    version: str
    last_updated: datetime
```

**Key Configuration Categories**:

- `normalization_rules`: Vietnamese text processing rules configuration
- `ui_preferences`: Window size, position, recent folders
- `operation_settings`: Default behaviors, safety settings

### Database Integration Architecture

From backend architecture [Source: architecture/backend-architecture.md]:

**Configuration Database Schema**:

```sql
CREATE TABLE app_config (
    id INTEGER PRIMARY KEY,
    key TEXT UNIQUE NOT NULL,
    value TEXT NOT NULL,
    data_type TEXT NOT NULL CHECK (data_type IN ('string', 'json', 'boolean', 'integer')),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**ConfigRepository Implementation Pattern**:

```python
class ConfigRepository:
    async def load_configuration(self) -> AppConfiguration:
        """Load complete application configuration"""
  
    async def save_configuration(self, config: AppConfiguration) -> None:
        """Persist configuration changes"""
  
    async def reset_to_defaults(self) -> AppConfiguration:
        """Reset all settings to default values"""
```

### Service Layer Architecture

From backend architecture [Source: architecture/backend-architecture.md]:

**ConfigService Implementation**:

```python
class ConfigService:
    def __init__(self):
        self.repository = ConfigRepository()
        self.current_config: Optional[AppConfiguration] = None
  
    async def load_user_preferences(self) -> AppConfiguration:
        """Initialize application với saved settings"""
  
    async def save_configuration_changes(self, config: AppConfiguration) -> None:
        """Persist user modifications to disk"""
  
    async def add_recent_folder(self, folder_path: str) -> None:
        """Track recent folders với limit management"""
  
    async def get_normalization_rules(self) -> Dict[str, bool]:
        """Get current normalization rules configuration"""
  
    async def update_normalization_rules(self, rules: Dict[str, bool]) -> None:
        """Update normalization rules với immediate application"""
```

### UI Component Architecture

From frontend architecture [Source: architecture/frontend-architecture.md]:

**Settings Panel Component** [Source: architecture/unified-project-structure.md]:

- Location: `src/ui/components/settings_panel.py`
- Integration: Dialog component with tabbed interface
- State Management: Integrated với ApplicationState

**Settings Dialog Structure**:

```python
class SettingsDialog(BaseComponent):
    def __init__(self, parent, config_service: ConfigService):
        self.config_service = config_service
        self.current_config: Optional[AppConfiguration] = None
        self.setup_ui()
  
    def setup_ui(self) -> None:
        """Create tabbed settings interface"""
        # Normalization Rules Tab
        # UI Preferences Tab  
        # Advanced Settings Tab
  
    def apply_settings(self) -> None:
        """Apply settings changes immediately"""
  
    def reset_to_defaults(self) -> None:
        """Reset all settings với user confirmation"""
```

### Normalization Rules Integration

From existing normalization service [Source: architecture/components.md]:

**Vietnamese Text Processor Integration**:

- Existing interfaces: `normalize_vietnamese_text()`, `clean_file_name()`, `apply_custom_rules()`
- Extension needed: Dynamic rule configuration from user settings
- Custom rules: User-defined text transformation patterns

**Enhanced Normalization Rules Model**:

```python
@dataclass
class NormalizationRules:
    remove_diacritics: bool = True
    convert_to_lowercase: bool = True
    clean_special_characters: bool = True
    custom_replacements: Dict[str, str] = field(default_factory=dict)
    preserve_extensions: bool = True
    max_filename_length: int = 255
```

### UI State Management Integration

From frontend architecture [Source: architecture/frontend-architecture.md]:

**Enhanced ApplicationState for Settings**:

```python
@dataclass
class ApplicationState:
    # Configuration State
    current_config: Optional[AppConfiguration] = None
    settings_dialog_open: bool = False
    settings_changed: bool = False
  
    # Recent Folders State
    recent_folders: List[str] = field(default_factory=list)
  
    def update_configuration(self, config: AppConfiguration) -> None:
        """Update configuration và trigger re-render"""
        self.current_config = config
        self.settings_changed = True
```

### User Profile Directory Integration

From tech stack [Source: architecture/tech-stack.md]:

**Configuration File Location Strategy**:

| Platform       | Configuration Path                     |
| -------------- | -------------------------------------- |
| Windows        | `%APPDATA%/FileRenameTool/config.db` |
| Cross-platform | `~/.config/filerenametool/config.db` |

**Configuration Persistence Technology**:

- Database: SQLite with JSON fields cho complex settings
- File System: pathlib cho cross-platform path handling
- Serialization: JSON cho configuration export/import

### Error Handling Integration

From error handling system [Source: Story 2.4 completion notes]:

**Settings-Specific Error Scenarios**:

- Configuration file corruption
- Invalid custom replacement rules
- Database connection failures
- Permission denied accessing config directory
- Settings validation failures

**Error Recovery Strategies**:

- Automatic fallback to default settings
- Configuration backup và restore
- User-friendly validation messages
- Graceful degradation cho partial settings failures

### File System Integration Requirements

From unified project structure [Source: architecture/unified-project-structure.md]:

**Settings Component Locations**:

- Settings Dialog: `src/ui/dialogs/settings_dialog.py`
- Settings Panel: `src/ui/components/settings_panel.py`
- Config Service: `src/core/services/config_service.py`
- Config Repository: `src/core/repositories/config_repository.py`
- Config Models: `src/core/models/config.py`

### Technology Stack Requirements

From tech stack [Source: architecture/tech-stack.md]:

| Component            | Technology                 | Purpose                        |
| -------------------- | -------------------------- | ------------------------------ |
| Configuration UI     | tkinter.ttk.Notebook       | Tabbed settings interface      |
| Data Persistence     | SQLite                     | Configuration storage          |
| Configuration Format | JSON                       | Structured settings data       |
| File Operations      | pathlib                    | Cross-platform path handling   |
| Validation           | Existing ValidationService | Settings input validation      |
| Error Handling       | Existing ErrorHandler      | Configuration error management |

### Testing Requirements

From testing strategy [Source: architecture/testing-strategy.md]:

**Unit Tests Required**:

- test_configuration_model_validation()
- test_config_service_load_save()
- test_settings_dialog_ui_components()
- test_normalization_rules_application()
- test_recent_folders_management()

**Integration Tests Required**:

- test_complete_settings_workflow()
- test_configuration_persistence()
- test_settings_immediate_application()
- test_error_recovery_settings()

**UI Tests Required**:

- test_settings_dialog_interaction()
- test_custom_rules_editor()
- test_reset_to_defaults_functionality()
- test_settings_validation_feedback()

### Testing

#### Testing Standards

From testing strategy [Source: architecture/testing-strategy.md]:

**Unit Tests**:

- Location: `tests/unit/test_user_preferences_settings.py`
- Framework: pytest với mock database scenarios
- Coverage: Configuration models, service layer, UI components, validation

**Integration Tests**:

- Location: `tests/integration/test_settings_integration.py`
- Framework: pytest-qt cho UI integration testing
- Coverage: Complete settings workflows, persistence, real-time application

**UI Tests**:

- Location: `tests/ui/test_settings_interface.py`
- Framework: pytest-qt với UI automation
- Coverage: Settings dialog interaction, validation feedback, user experience

#### Specific Testing Requirements for This Story:

- Test configuration loading và saving với various data types
- Test settings dialog UI với all tabs và input components
- Test normalization rules customization với preview functionality
- Test UI preferences persistence across application sessions
- Test recent folders management với maximum limits
- Test "Reset to Defaults" functionality với user confirmation
- Test immediate settings application without restart requirement
- Test error handling cho configuration corruption và recovery scenarios
- Test cross-platform configuration file location và access
- Test settings validation với invalid input scenarios

## Change Log

| Date       | Version | Description                                     | Author        |
| ---------- | ------- | ----------------------------------------------- | ------------- |
| 2025-08-31 | v1.0    | Initial story creation from Epic 3 requirements | Anh Minh (SM) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results

*This section will be populated by the QA agent after story completion*
